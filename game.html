<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Ranch</title>
  <link rel="stylesheet" href="style.css" />

</head>
<body>
  <div class="dashboard-layout">
    <!-- Left Sidebar -->
    <div class="sidebar left-sidebar">
      <h3>Virtual Ranch</h3>
      <ul>
        <li onclick="showTab('myranch')">My Ranch</li>
        <li onclick="showTab('stables')">Stables</li>
        <li onclick="showTab('sales')">Sales</li>
        <li onclick="showTab('shows')">Shows</li>
        <li onclick="showTab('training')">Training</li>
        <li onclick="showTab('jobs')">Jobs</li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-panel">
      <h2 id="welcomeUser"></h2>
      <div id="coinCounter">Coins: 0</div>

      <div id="newsSection">
        <h3>Latest News</h3>
        <div id="newsList"></div>
      </div>

      <div id="myranch" class="content">
        <h2>Your Ranch</h2>
        <div class="player-profile">
          <p><strong>Username:</strong> <span id="profileUsername"></span></p>
          <p><strong>Level:</strong> <span id="profileLevel"></span></p>
          <p><strong>Current Job:</strong> <span id="profileJob"></span></p>
          <p><strong>Total Horses:</strong> <span id="profileHorseCount"></span></p>
          <p><strong>Join Date:</strong> <span id="profileJoinDate"></span></p>
          <p><strong>EXP:</strong> <span id="profileExp"></span></p>
          <div style="background: #ccc; border-radius: 5px; overflow: hidden; height: 20px;">
            <div id="profileExpBar" style="width: 0%; background: #4caf50; height: 100%;"></div>
          </div>
        </div>
      </div>

      <div id="stables" class="content">
        <h2>Your Stable</h2>
        <div id="stableGrid" class="stable-grid"></div>
      </div>

      <div id="horseDetail" class="content" style="display: none;">
        <h2 id="horseNameDetail"></h2>
        <div id="horseDetailInfo"></div>
        <button onclick="changeHorseName()">Change Name</button>
        <button onclick="prepareBreeding()">Breed</button>
        <button onclick="enterShow()">Enter Shows</button>
        <button onclick="showTab('stables')">Back to Stable</button>
      </div>

      <div id="sales" class="content">
        <h2>Horses for Sale</h2>
        <div id="salesList"></div>
      </div>

      <div id="shows" class="content">
        <h2>Horse Shows</h2>
        <p>Enter your horses into competitions to gain EXP and level up!</p>
        <div id="showEntries"></div>
      </div>

      <div id="training" class="content"><h2>Training</h2></div>

      <div id="jobs" class="content">
        <h2>Jobs</h2>
        <div id="jobInfo"></div>
        <div id="jobActions"></div>
      </div>

      <div id="clubhouse" class="content">
        <h2>Clubhouse</h2>
        <div id="riderInfo"></div>
      </div>

      <div id="barn" class="content">
        <h2>Barn</h2>
        <div id="barn-tabs">
          <div id="inventory" class="barn-tab">
            <h3>Inventory</h3>
            <div id="inventoryContent">Inventory items will display here</div>
          </div>
          <div id="workshop" class="barn-tab" style="display:none">
            <h3>Workshop</h3>
            <button onclick="craftTack('Bridle')">Craft Bridle</button>
            <button onclick="craftTack('Saddle')">Craft Saddle</button>
            <button onclick="craftTack('Horse Boots')">Craft Horse Boots</button>
            <button onclick="craftTack('Horse Shoes')">Craft Horse Shoes</button>
          </div>
          <div id="tackroom" class="barn-tab" style="display:none">
            <h3>Tack Room</h3>
            <div id="tackContent">Crafted tack items will show here</div>
          </div>
        </div>
      </div>

      <div id="settings" class="content">
        <h2>Settings</h2>
        <button onclick="logout()">Log Out</button>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar right-sidebar">
      <ul>
        <li onclick="showTab('barn')">Barn</li>
        <li onclick="showSubTab('barn', 'inventory')">- Inventory</li>
        <li onclick="showSubTab('barn', 'workshop')">- Workshop</li>
        <li onclick="showSubTab('barn', 'tackroom')">- Tack Room</li>
        <li onclick="showTab('clubhouse')">Clubhouse</li>
        <li onclick="showTab('settings')">Settings</li>
      </ul>
    </div>
  </div>

  <!-- Main Script -->
  <script type="module" src="script.js"></script>

  <script>
    function showTab(id) {
      document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
      document.getElementById("newsSection").style.display = (id === 'myranch') ? 'block' : 'none';
    }

    function showSubTab(main, subId) {
      document.querySelectorAll(`#${main} .barn-tab`).forEach(tab => tab.style.display = 'none');
      const sub = document.getElementById(subId);
      if (sub) sub.style.display = 'block';
      showTab(main);
    }

    function logout() {
      localStorage.removeItem("activeUser");
      localStorage.removeItem("salesHorses");
      window.location.href = "index.html";
    }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
  import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCkFOc0BwRqmR2LkjHj0vwXSAS1h4BlBCE",
    authDomain: "horse-game-by-sxxrrx.firebaseapp.com",
    projectId: "horse-game-by-sxxrrx",
    storageBucket: "horse-game-by-sxxrrx.appspot.com",
    messagingSenderId: "87883054918",
    appId: "1:87883054918:web:4771a90eb5c6a3e7c0ef47",
    measurementId: "G-ZW6W5HVXBJ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // Helper: Save user to Firebase
  async function saveUserToFirebase(userId, userData) {
    const userRef = ref(db, 'users/' + userId);
    await set(userRef, userData);
  }

  // Helper: Create sales horses if missing
  function generateHorsesForSale() {
    const breeds = {
      "Friesian": ["Black"],
      "Thoroughbred": ["Bay", "Dark Bay", "Chestnut", "Liver Chestnut", "Black"],
      "Arabian": ["Black", "Bay", "Dark Bay", "Chestnut", "Liver Chestnut", "Grey"]
    };
    const genders = ["Mare", "Stallion"];
    const breedKeys = Object.keys(breeds);

    const horses = [];
    for (let i = 0; i < 5; i++) {
      const breed = breedKeys[Math.floor(Math.random() * breedKeys.length)];
      const coatColor = breeds[breed][Math.floor(Math.random() * breeds[breed].length)];
      const gender = genders[Math.floor(Math.random() * genders.length)];
      horses.push({
        id: 'horse_' + Date.now() + "_" + i,
        name: `${breed} (${coatColor} ${gender})`,
        breed,
        coatColor,
        gender,
        price: 1000,
        level: 1,
        exp: 0,
        age: { years: 3, months: 0 }
      });
    }
    localStorage.setItem("salesHorses", JSON.stringify({ timestamp: Date.now(), horses }));
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    const dbRef = ref(db);
    const snapshot = await get(child(dbRef, `users/${user.uid}`));
    if (!snapshot.exists()) return alert("User data not found.");

    const userData = snapshot.val();

    // Initialize missing data
    if (!userData.horses || userData.horses.length === 0) {
      userData.horses = [{
        id: 'horse_' + Date.now(),
        name: "Arabian (Grey Stallion)",
        breed: "Arabian",
        coatColor: "Grey",
        gender: "Stallion",
        level: 1,
        exp: 0,
        age: { years: 3, months: 0 }
      }];
    }

    if (!userData.tack) userData.tack = [];
    if (!userData.rider) userData.rider = null;
    if (!userData.job) userData.job = "Stablehand";

    // Sales horses
    const sales = JSON.parse(localStorage.getItem("salesHorses"));
    const now = Date.now();
    const THIRTY_MIN = 30 * 60 * 1000;
    if (!sales || now - sales.timestamp > THIRTY_MIN) {
      generateHorsesForSale();
    }

    // Store in localStorage for legacy functions
    localStorage.setItem("activeUser", JSON.stringify(userData));

    // Show UI
    document.getElementById("welcomeUser").textContent = `Welcome, ${userData.username}!`;
    document.getElementById("coinCounter").textContent = `Coins: ${userData.coins}`;

    const news = [
      "Welcome to HORSE GAME",
      "New event: coming soon...",
      "News Update: New Version of HORSE GAME v4.1.1"
    ];
    const newsListContainer = document.getElementById("newsList");
    news.forEach(item => {
      const div = document.createElement("div");
      div.textContent = item;
      newsListContainer.appendChild(div);
    });

    showProfile(userData);
    renderStables(userData);
    renderSalesHorses(userData);
    setupJobs(userData);
    showRider(userData);
    showTack(userData);
    showTab("stables");

    // Save any newly initialized defaults
    await saveUserToFirebase(user.uid, userData);
  });
</script>

</body>
</html>
